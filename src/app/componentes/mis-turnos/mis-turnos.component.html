<div class="mis-turnos-container">
  <h2 *ngIf="esPaciente">üóìÔ∏è Mis Turnos</h2>
  <h2 *ngIf="esEspecialista">Turnos Asignados</h2>
  <div *ngIf="mensajeExito" class="mensaje-exito-turno">
    {{ mensajeExito }}
  </div>
  <input type="text" [(ngModel)]="filtro" (input)="aplicarFiltro()" placeholder="üîé Buscar por especialidad o {{esPaciente ? 'especialista' : 'paciente'}}..." class="filtro-input" />

  <div *ngIf="turnosFiltrados.length === 0" class="mensaje-vacio">
    <span *ngIf="esPaciente">üôÅ No tienes turnos para mostrar.</span>
    <span *ngIf="esEspecialista">üôÅ No tienes turnos asignados.</span>
  </div>

  <table *ngIf="turnosFiltrados.length > 0" class="tabla-turnos">
    <thead>
      <tr>
        <th>Especialidad</th>
        <th *ngIf="esPaciente">Especialista</th>
        <th *ngIf="esEspecialista">Paciente</th>
        <th *ngIf="esAdmin">Paciente</th>
        <th *ngIf="esAdmin">Especialista</th>
        <th>Fecha</th>
        <th>Horario</th>
        <th>Estado</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let turno of turnosFiltrados">
        <td>{{ turno.especialidad }}</td>
        <td *ngIf="esPaciente">{{ turno.especialistaNombre }} {{ turno.especialistaApellido }}</td>
        <td *ngIf="esEspecialista">{{ turno.pacienteNombre || '' }} {{ turno.pacienteApellido || '' }}</td>
        <td *ngIf="esAdmin">{{ turno.pacienteNombre || '' }} {{ turno.pacienteApellido || '' }}</td>
        <td *ngIf="esAdmin">{{ turno.especialistaNombre || '' }} {{ turno.especialistaApellido || '' }}</td>
        <td>{{ turno.FechaTurno | formatoFecha:'customDiaMesAnioDia' }}</td>
        <td>{{ turno.HorarioTurno }}</td>
        <td>
          <span class="estado-{{ turno.estado }}">
            <ng-container [ngSwitch]="turno.estado">
              <span *ngSwitchCase="'pendiente'">Pendiente</span>
              <span *ngSwitchCase="'confirmado'">Confirmado</span>
              <span *ngSwitchCase="'aceptado'">Aceptado</span>
              <span *ngSwitchCase="'realizado'">Realizado</span>
              <span *ngSwitchCase="'rechazado'">Rechazado</span>
              <span *ngSwitchCase="'cancelado'">Cancelado</span>
              <span *ngSwitchDefault>{{ turno.estado | titlecase }}</span>
            </ng-container>
          </span>
        </td>
        <td>
          <!-- PACIENTE: Cancelar, Ver Rese√±a, Encuesta -->
          <ng-container *ngIf="esPaciente">
            <span *ngIf="turno.estado === 'pendiente' || turno.estado === 'confirmado'">
              <button class="btn-cancelar" (click)="abrirModalCancelar(turno)">Cancelar</button>
            </span>
            <span *ngIf="turno.estado === 'realizado' && turno.resena">
              <button class="btn-ver" (click)="abrirModalResena(turno)">Ver Rese√±a</button>
            </span>
            <span *ngIf="turno.estado === 'realizado' && !turno.encuestaCompletada">
              <button class="btn-encuesta" (click)="abrirModalEncuesta(turno)">Encuesta</button>
            </span>
          </ng-container>
          <!-- ESPECIALISTA: Aceptar, Rechazar, Cancelar, Finalizar, Ver Rese√±a -->
          <ng-container *ngIf="esEspecialista">
            <span *ngIf="(turno.estado === 'pendiente')">
              <button class="btn-aceptar" (click)="aceptarTurno(turno)">Aceptar</button>
              <button class="btn-rechazar" (click)="abrirModalRechazar(turno)">Rechazar</button>
            </span>
            <span *ngIf="(turno.estado === 'aceptado')">
              <button class="btn-cancelar" (click)="abrirModalCancelar(turno)">Cancelar</button>
              <button class="btn-cancelar" (click)="abrirModalFinalizar(turno)">Finalizar</button>
            </span>
            <span *ngIf="turno.resena">
              <button class="btn-ver" (click)="abrirModalResena(turno)">Ver Rese√±a</button>
            </span>
            <span *ngIf="turno.encuestaCompletada">
              <button class="btn-ver" (click)="abrirModalVerEncuesta(turno)">Ver Encuesta</button>
            </span>
          </ng-container>
          <ng-container *ngIf="esAdmin">
            <span *ngIf="puedeCancelarAdmin(turno)">
              <button class="btn-cancelar" (click)="abrirModalCancelar(turno)">Cancelar</button>
            </span>
            <span *ngIf="(turno.estado === 'cancelado' && turno.comentarioCancelacion)">
              <button class="btn-ver" (click)="abrirModalMotivo(turno)">Ver Motivo</button>
            </span>
          </ng-container>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Modal cancelar turno (paciente o especialista) -->
  <div class="modal-cancelar" *ngIf="mostrarModalCancelar">
    <div class="modal-content">
      <h3>Cancelar turno</h3>
      <p>Por favor, ingresa el motivo de la cancelaci√≥n:</p>
      <textarea [(ngModel)]="motivoOperacion" rows="3" placeholder="Motivo..." class="textarea-motivo"></textarea>
      <div *ngIf="errorMotivo" class="error-motivo">{{ errorMotivo }}</div>
      <div class="modal-actions">
        <button (click)="confirmarCancelacion()" class="btn-cancelar-modal">Confirmar</button>
        <button (click)="cerrarModalCancelar()" class="btn-cerrar-modal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal rechazar turno (solo especialista) -->
  <div class="modal-cancelar" *ngIf="mostrarModalRechazar">
    <div class="modal-content">
      <h3>Rechazar turno</h3>
      <p>Por favor, ingresa el motivo del rechazo:</p>
      <textarea [(ngModel)]="motivoOperacion" rows="3" placeholder="Motivo..." class="textarea-motivo"></textarea>
      <div *ngIf="errorMotivo" class="error-motivo">{{ errorMotivo }}</div>
      <div class="modal-actions">
        <button (click)="confirmarRechazo()" class="btn-cancelar-modal">Confirmar</button>
        <button (click)="cerrarModalRechazar()" class="btn-cerrar-modal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal finalizar turno (solo especialista) -->
  <div class="modal-cancelar" *ngIf="mostrarModalFinalizar">
    <div class="modal-content">
      <h3>Finalizar turno</h3>
      <form (ngSubmit)="confirmarFinalizacion()" autocomplete="off">
        <div class="historia-clinica-section">
          <h4>Historia Cl√≠nica</h4>
          <div class="datos-fijos">
            <label>Altura (cm): <input type="number" [(ngModel)]="altura" name="altura" required min="0" /></label>
            <label>Peso (kg): <input type="number" [(ngModel)]="peso" name="peso" required min="0" /></label>
            <label>Temperatura (¬∞C): <input type="number" [(ngModel)]="temperatura" name="temperatura" required min="0" step="0.1" /></label>
            <label>Presi√≥n: <input type="text" [(ngModel)]="presion" name="presion" required /></label>
          </div>
          <div class="datos-dinamicos">
            <label>Dato:</label>
            <input type="text" [(ngModel)]="claveDinamica" name="claveDinamica" maxlength="20" />
            <input type="text" [(ngModel)]="valorDinamico" name="valorDinamico" maxlength="30"/>
            <button type="button" (click)="agregarDatoDinamico()" [disabled]="datosDinamicos.length >= 3">Agregar</button>
          </div>
          <div class="chips-dinamicos">
            <span class="chip-dinamico" *ngFor="let dato of datosDinamicos; let i = index">
              {{dato.clave}}: {{dato.valor}}
              <button type="button" (click)="eliminarDatoDinamico(i)">x</button>
            </span>
          </div>
        </div>
        <p>Por favor, ingresa una rese√±a o comentario de la consulta:</p>
        <textarea [(ngModel)]="resenaFinal" name="resenaFinal" rows="3" placeholder="Comentario o diagn√≥stico..." class="textarea-motivo" required></textarea>
        <div *ngIf="errorMotivo" class="error-motivo">{{ errorMotivo }}</div>
        <div *ngIf="errorHistoriaClinica" class="error-motivo">{{ errorHistoriaClinica }}</div>
        <div class="modal-actions">
          <button type="submit" class="btn-finalizar-modal">Finalizar</button>
          <button type="button" (click)="cerrarModalFinalizar()" class="btn-cerrar-modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal ver rese√±a -->
  <div class="modal-cancelar" *ngIf="mostrarModalResena">
    <div class="modal-content">
      <h3>Rese√±a del turno</h3>
      <p class="resena-texto">{{ resenaAMostrar }}</p>
      <div class="modal-actions">
        <button (click)="cerrarModalResena()" class="btn-cerrar-modal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal ver motivo -->
  <div class="modal-cancelar" *ngIf="mostrarModalMotivo">
    <div class="modal-content">
      <h3>Motivo de {{ turnoAOperar?.estado | titlecase }}</h3>
      <p class="resena-texto">{{ motivoAMostrar }}</p>
      <div class="modal-actions">
        <button (click)="cerrarModalMotivo()" class="btn-cerrar-modal">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal encuesta -->
  <div class="modal-cancelar" *ngIf="mostrarModalEncuesta">
    <div class="modal-content">
      <h3>Encuesta sobre la atenci√≥n</h3>
      <form (ngSubmit)="confirmarEncuesta()" autocomplete="off">
        <label for="comentarioEncuesta">Comentario para el m√©dico:</label>
        <textarea id="comentarioEncuesta" [(ngModel)]="comentarioEncuesta" name="comentarioEncuesta" rows="3" placeholder="Escribe tu comentario..." class="textarea-motivo" required></textarea>
        <div class="estrellas-encuesta">
          <label>Calificaci√≥n:</label>
          <ng-container *ngFor="let star of [1,2,3,4,5]">
            <span (click)="estrellasEncuesta = star" [class.selected]="estrellasEncuesta >= star" class="estrella">‚òÖ</span>
          </ng-container>
        </div>
        <div *ngIf="errorEncuesta" class="error-motivo">{{ errorEncuesta }}</div>
        <div class="modal-actions">
          <button type="submit" class="btn-finalizar-modal">Enviar</button>
          <button type="button" (click)="cerrarModalEncuesta()" class="btn-cerrar-modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal ver encuesta (solo especialista) -->
  <div class="modal-cancelar" *ngIf="mostrarModalVerEncuesta">
    <div class="modal-content">
      <h3>Encuesta del paciente</h3>
      <div class="ver-encuesta-contenido">
        <div class="ver-encuesta-estrellas">
          <ng-container *ngFor="let star of [1,2,3,4,5]">
            <span class="estrella" [class.selected]="star <= encuestaEstrellasVer">‚òÖ</span>
          </ng-container>
        </div>
        <div class="ver-encuesta-comentario">
          <strong>Comentario:</strong>
          <p>{{ encuestaComentarioVer }}</p>
        </div>
      </div>
      <div class="modal-actions">
        <button (click)="cerrarModalVerEncuesta()" class="btn-cerrar-modal">Cerrar</button>
      </div>
    </div>
  </div>
</div> 